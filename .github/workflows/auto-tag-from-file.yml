name: Auto Tag from Version File
on:
  push:
    branches: [ main, master ]
    # 仅当VERSION文件修改时触发（可选，减少不必要的执行）
    paths: [ 'VERSION' ]

# 关键：添加权限声明
permissions:
  contents: write  # 允许写入仓库内容（包括Tag、分支）
  pull-requests: read  # 可选，仅读取PR信息

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 读取VERSION文件中的版本号
      - name: Get version from file
        id: get_version
        run: |
          VERSION=$(cat VERSION)
          # 拼接v前缀（如1.0.0→v1.0.0）
          NEW_TAG="v$VERSION"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      # 2. 推送Tag
      - name: Push tag to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # 检查Tag是否已存在，避免重复推送
          if ! git rev-parse ${{ steps.get_version.outputs.new_tag }} >/dev/null 2>&1; then
            git tag ${{ steps.get_version.outputs.new_tag }}
            git push origin ${{ steps.get_version.outputs.new_tag }}
            echo "Tag ${{ steps.get_version.outputs.new_tag }} pushed successfully"
          else
            echo "Tag ${{ steps.get_version.outputs.new_tag }} already exists"
          fi
